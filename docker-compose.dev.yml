version: '3.8'

services:
  # Development WordPress Instance
  wordpress_dev:
    image: wordpress:latest
    container_name: 3dmakeme_wordpress_dev
    restart: unless-stopped
    ports:
      - "${DEV_WP_PORT:-8090}:80"
    environment:
      WORDPRESS_DB_HOST: mysql_dev:3306
      WORDPRESS_DB_USER: ${DEV_DB_USER:-wordpress_dev}
      WORDPRESS_DB_PASSWORD: ${DEV_DB_PASSWORD:-wordpress_password}
      WORDPRESS_DB_NAME: ${DEV_DB_NAME:-wordpress_dev}
      WORDPRESS_TABLE_PREFIX: ${DEV_WP_TABLE_PREFIX:-lmf_}
      WORDPRESS_DEBUG: ${DEV_WP_DEBUG:-1}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG', true);
        define('WP_DEBUG_LOG', true);
        define('WP_DEBUG_DISPLAY', false);
        define('SCRIPT_DEBUG', true);
        define('SAVEQUERIES', true);
        define('WP_MEMORY_LIMIT', '512M');
        define('WP_ENVIRONMENT_TYPE', 'development');

        // Email via MailHog
        define('SMTP_HOST', 'mailhog_dev');
        define('SMTP_PORT', 1025);
        define('SMTP_SECURE', false);
        define('SMTP_AUTH', false);

        ini_set('memory_limit', '512M');
        ini_set('upload_max_filesize', '64M');
        ini_set('post_max_size', '64M');
        ini_set('max_execution_time', 300);
    volumes:
      - ./uploads:/var/www/html/wp-content/uploads
      - ./themes:/var/www/html/wp-content/themes
      - ./plugins:/var/www/html/wp-content/plugins
    depends_on:
      - mysql_dev
      - mailhog_dev
    networks:
      - wordpress_dev_network

  # Development MySQL Database
  mysql_dev:
    image: mysql:8.0
    container_name: 3dmakeme_mysql_dev
    restart: unless-stopped
    ports:
      - "${DEV_DB_PORT:-3307}:3306"
    environment:
      MYSQL_DATABASE: ${DEV_DB_NAME:-wordpress_dev}
      MYSQL_USER: ${DEV_DB_USER:-wordpress_dev}
      MYSQL_PASSWORD: ${DEV_DB_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${DEV_DB_ROOT_PASSWORD:-root_password}
    volumes:
      - mysql_dev_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    command: '--default-authentication-plugin=mysql_native_password'
    networks:
      - wordpress_dev_network

  # Production MySQL Database (on same server)
  mysql_prod:
    image: mysql:8.0
    container_name: 3dmakeme_mysql_prod
    restart: unless-stopped
    ports:
      - "${PROD_DB_PORT:-3308}:3306"
    environment:
      MYSQL_DATABASE: ${PROD_DB_NAME:-wordpress_prod}
      MYSQL_USER: ${PROD_DB_USER:-wordpress_prod}
      MYSQL_PASSWORD: ${PROD_DB_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${PROD_DB_ROOT_PASSWORD:-root_password}
    volumes:
      - mysql_prod_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    command: '--default-authentication-plugin=mysql_native_password'
    networks:
      - wordpress_prod_network

  # phpMyAdmin for Development Database
  phpmyadmin_dev:
    image: phpmyadmin/phpmyadmin:latest
    container_name: 3dmakeme_phpmyadmin_dev
    restart: unless-stopped
    ports:
      - "${DEV_PMA_PORT:-8091}:80"
    environment:
      PMA_HOST: mysql_dev
      PMA_PORT: 3306
      PMA_USER: ${DEV_DB_USER:-wordpress_dev}
      PMA_PASSWORD: ${DEV_DB_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${DEV_DB_ROOT_PASSWORD:-root_password}
      PMA_ARBITRARY: 1
    depends_on:
      - mysql_dev
    networks:
      - wordpress_dev_network
      - wordpress_prod_network

  # MailHog for Development Email Testing
  mailhog_dev:
    image: mailhog/mailhog:latest
    container_name: 3dmakeme_mailhog_dev
    restart: unless-stopped
    ports:
      - "${DEV_MAILHOG_SMTP:-1026}:1025"  # SMTP
      - "${DEV_MAILHOG_WEB:-8026}:8025"   # Web UI
    networks:
      - wordpress_dev_network

volumes:
  mysql_dev_data:
    name: 3dmakeme_mysql_dev_data
  mysql_prod_data:
    name: 3dmakeme_mysql_prod_data

networks:
  wordpress_dev_network:
    driver: bridge
    name: 3dmakeme_dev_network
  wordpress_prod_network:
    driver: bridge
    name: 3dmakeme_prod_network
