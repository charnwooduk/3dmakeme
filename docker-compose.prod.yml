version: '3.8'

services:
  # Production WordPress Instance
  wordpress_prod:
    image: wordpress:latest
    container_name: 3dmakeme_wordpress_prod
    restart: unless-stopped
    ports:
      - "${PROD_WP_PORT:-8092}:80"
    environment:
      WORDPRESS_DB_HOST: mysql_prod:3306
      WORDPRESS_DB_USER: ${PROD_DB_USER:-wordpress_prod}
      WORDPRESS_DB_PASSWORD: ${PROD_DB_PASSWORD:-wordpress_password}
      WORDPRESS_DB_NAME: ${PROD_DB_NAME:-wordpress_prod}
      WORDPRESS_TABLE_PREFIX: ${PROD_WP_TABLE_PREFIX:-lmf_}
      WORDPRESS_DEBUG: ${PROD_WP_DEBUG:-0}
      WORDPRESS_CONFIG_EXTRA: |
        define('WP_DEBUG', false);
        define('WP_DEBUG_LOG', false);
        define('WP_DEBUG_DISPLAY', false);
        define('WP_MEMORY_LIMIT', '512M');
        define('WP_ENVIRONMENT_TYPE', 'production');
        define('DISALLOW_FILE_EDIT', true);
        define('DISALLOW_FILE_MODS', false);

        ini_set('memory_limit', '512M');
        ini_set('upload_max_filesize', '64M');
        ini_set('post_max_size', '64M');
        ini_set('max_execution_time', 300);
    volumes:
      - ./uploads:/var/www/html/wp-content/uploads
      - ./themes:/var/www/html/wp-content/themes
      - ./plugins:/var/www/html/wp-content/plugins
    depends_on:
      - mysql_prod
    networks:
      - wordpress_prod_network

  # Production MySQL Database
  mysql_prod:
    image: mysql:8.0
    container_name: 3dmakeme_mysql_prod
    restart: unless-stopped
    ports:
      - "${PROD_DB_PORT:-3308}:3306"
    environment:
      MYSQL_DATABASE: ${PROD_DB_NAME:-wordpress_prod}
      MYSQL_USER: ${PROD_DB_USER:-wordpress_prod}
      MYSQL_PASSWORD: ${PROD_DB_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${PROD_DB_ROOT_PASSWORD:-root_password}
    volumes:
      - mysql_prod_data:/var/lib/mysql
      - ./mysql-init:/docker-entrypoint-initdb.d
    command: '--default-authentication-plugin=mysql_native_password'
    networks:
      - wordpress_prod_network

  # phpMyAdmin for Production Database
  phpmyadmin_prod:
    image: phpmyadmin/phpmyadmin:latest
    container_name: 3dmakeme_phpmyadmin_prod
    restart: unless-stopped
    ports:
      - "${PROD_PMA_PORT:-8093}:80"
    environment:
      PMA_HOST: mysql_prod
      PMA_PORT: 3306
      PMA_USER: ${PROD_DB_USER:-wordpress_prod}
      PMA_PASSWORD: ${PROD_DB_PASSWORD:-wordpress_password}
      MYSQL_ROOT_PASSWORD: ${PROD_DB_ROOT_PASSWORD:-root_password}
      PMA_ARBITRARY: 1
    depends_on:
      - mysql_prod
    networks:
      - wordpress_prod_network

volumes:
  mysql_prod_data:
    name: 3dmakeme_mysql_prod_data

networks:
  wordpress_prod_network:
    driver: bridge
    name: 3dmakeme_prod_network
